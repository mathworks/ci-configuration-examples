version: 2.1

orbs: 
  win: circleci/windows@5
  matlab: mathworks/matlab@1

executors:
  linux:
    machine:
      image: ubuntu-2204:current
  macos:
    macos:
      xcode: 14.2.0
    resource_class: macos.m1.medium.gen1
  windows: 
    win/default

jobs:
  build:
    parameters:
      os:
        type: executor
      release:
        type: string
    executor: <<parameters.os>>
    environment:
       MATLAB_LOG_DIR: /home/circleci/project/logs
       MW_DIAGNOSTIC_DEST: file
       MW_DIAGNOSTIC_SPEC: cppmicroservices::framework.*=all;install.*=all;
       MW_VERBOSE_HTTPCLIENT_CORE: 1
       MW_BATCH_LICENSING_ONLINE: true # testing online validation, can remove when this becomes the default
    steps:
      - checkout
      - when:
          condition:
            equal: ["<<parameters.os>>", "linux"]
          steps:
            - run:
                name: Remove problematic Launchpad PPAs
                command: |
                  echo "Removing PPA sources from /etc/apt/sources.list.d"
                  sudo find /etc/apt/sources.list.d/ -type f -name '*.list' -exec grep -l 'ppa.launchpad' {} \; | xargs sudo rm -f
      - matlab/install:
          release: <<parameters.release>>
          products: Optimization_Toolbox Curve_Fitting_Toolbox
      - matlab/run-tests:
          source-folder: code
      - run:
          command: tar -cvzf matlab-logs.tar /home/circleci/project/logs
          when: on_fail
          shell: bash
      - store_artifacts:
          path: matlab-logs.tar
          when: on_fail

workflows:
  all-builds:
    jobs:
      - build:
         matrix:
           parameters:
              os: [linux, macos, windows]
              release: [R2021a, R2021b, R2022a, R2022b, R2023a, R2023b, R2024a, R2024b, R2025a, latest, latest-including-prerelease]
           # g3735302
           exclude:
             - os: macos
               release: R2025a
             - os: macos
               release: latest
             - os: macos
               release: latest-including-prerelease
